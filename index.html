<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
        <style>
            .similar ul {
                margin: 0;
                padding: 0;
	            list-style-type: none;
                list-style-image: none;
            }
            .similar li {
                display: inline;
            }
        </style>
    </head>
    <body>
        <h1>MetaCPAN recent</h1>

        <div id="container">
            <ul id="recent_modules">
            </ul>
        </div>

        <script src="jquery-1.8.3.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script>
            !function ($) {
                $(function(){
                    function on_metacpan (data) {
                        var dists = data.facets.leaderboard.terms.map(function (obj) {
                            return obj.term;
                        });

                        for (var i in dists) {
                            var dist = dists[i];

                            $('#recent_modules').append('<li id="dist-' + dist + '">' + dist + '<ul class="similar"></ul></li>');

                            $.ajax({
                                type: 'GET',
                                url: 'http://creaktive.cloudant.com/metacpan-recommendation/_design/recommend/_view/recommend',
                                dataType: 'jsonp',
                                data: {
                                    group: true,
                                    key: '"' + dist + '"',
                                    stale: 'ok'
                                }
                            }).done(on_similar);
                        }
                    }

                    function on_similar (data) {
                        for (var i in data.rows) {
                            var row = data.rows[i];

                            for (var similar in row.value) {
                                $('#dist-' + row.key + ' .similar').append('<li>' + similar + '</li>');
                            }
                        }
                    }

                    $.ajax({
                        type: 'POST',
                        url: 'http://api.metacpan.org/v0/favorite/_search',
                        data: {
                            source: JSON.stringify({
                                "query": {
                                    "match_all": {}
                                },
                                "facets": {
                                    "leaderboard": {
                                        "terms": {
                                            "field": "distribution",
                                            "size": 10
                                        }
                                    }
                                },
                                "size": 0
                            })
                        }
                    }).done(on_metacpan);
                })
            }(window.jQuery)
        </script>
    </body>
</html>
