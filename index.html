<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title></title>

        <style type="text/css">
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }

            .distribution {
                font-size: 1.5em;
            }

            #for-user {
                line-height: 2.15em;
            }
        </style>

        <link href="css/bootstrap.min.css" type="text/css" rel="stylesheet" media="screen">

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    </head>
    <body>
        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="brand" href="#">Project name</a>
                    <div class="nav-collapse collapse">
                        <ul class="nav">
                            <li class="active"><a href="#">Home</a></li>
                            <li><a href="#about">About</a></li>
                            <li><a href="#contact">Contact</a></li>
                        </ul>
                        <form id="query-recommendation" class="navbar-form pull-right">
                            <input id="pause" class="span2" type="text" placeholder="PAUSE account" pattern="[A-Za-z]*">
                            <button type="submit" class="btn">Recommend</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">

            <!-- Main hero unit for a primary marketing message or call to action -->
            <div class="hero-unit">
                <h1>MetaCPAN recent</h1>
                <p>This is a template for a simple marketing or informational website. It includes a large callout called the hero unit and three supporting pieces of content. Use it as a starting point to create something more unique.</p>
                <p><a class="btn btn-primary btn-large">Learn more &raquo;</a></p>
            </div>

            <p id="for-user">
                Type your
                <a href="http://pause.perl.org/" target="_blank">PAUSE</a>
                account above and hit the <em>Recommend</em> button!
            </p>
            <ol id="recent-modules"></ol>

            <hr>

            <footer>
                <p>&copy; Company 2012</p>
            </footer>

        </div>

        <script src="jquery-1.8.3.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script>
            (function ($) {
                'use strict';
                $(function () {
                    function cpan_module_name(str) {
                        return str.replace(new RegExp('-', 'g'), '::');
                    }

                    var dists = [];
                    function on_leaderboard (data) {
                        dists = data.facets.leaderboard.terms.map(function (obj) {
                            return obj.term;
                        });

                        $.ajax({
                            type: 'POST',
                            url: 'https://api.metacpan.org/v0/release/_search',
                            data: {
                                source: JSON.stringify({
                                    "query": {
                                        "terms": { "release.distribution": dists }
                                    },
                                    "filter": {
                                        "term" : {
                                            "release.status": "latest"
                                        }
                                    },
                                    "fields": [ "distribution", "abstract", "version" ]
                                })
                            }
                        }).done(on_releases);
                    }

                    function on_releases (data) {
                        var metadata = {};
                        for (var i in data.hits.hits) {
                            var row = data.hits.hits[i].fields;
                            metadata[row.distribution] = row;
                        }

                        for (var j in dists) {
                            var dist = dists[j];

                            $('#recent-modules').append(
                                '<li id="dist-' + dist + '">' +
                                '<a class="distribution" href="https://metacpan.org/release/' +
                                dist +
                                '" target="_blank"><b>' +
                                cpan_module_name(dist) +
                                '</b></a>' +
                                ' <small>v' + metadata[dist].version + '</small>' +
                                '<p>' + metadata[dist].abstract + '</p>' +
                                '<p class="similar">Loading...</p></li>'
                            );

                            $.ajax({
                                type: 'GET',
                                url: 'https://creaktive.cloudant.com/metacpan-recommendation/_design/recommend/_view/recommend',
                                dataType: 'jsonp',
                                data: {
                                    group: true,
                                    key: '"' + dist + '"',
                                    stale: 'ok'
                                }
                            }).done(on_similar);
                        }
                    }

                    function rank_sort(keys, vals) {
                        return keys.sort(function (b, a) {
                            var delta = vals[a] - vals[b];
                            if (delta) {
                                return delta;
                            } else if (a > b) {
                                return -1;
                            } else if (a < b) {
                                return 1;
                            } else {
                                return 0;
                            }
                        });
                    }

                    function on_similar (data) {
                        for (var i in data.rows) {
                            var row = data.rows[i];

                            var rank = {};
                            var tags = [];
                            for (var similar in row.value) {
                                rank[similar] = row.value[similar];
                                tags.push(similar);
                            }
                            tags = rank_sort(tags, rank).splice(0, 10).sort();

                            $('#dist-' + row.key + ' .similar').html('Similar:');
                            for (var j in tags) {
                                //console.log("%s %s", tags[i], rank[tags[i]]);
                                $('#dist-' + row.key + ' .similar').append(
                                    ' <a class="btn btn-small btn-info" type="button" href="https://metacpan.org/release/' +
                                    tags[j] +
                                    '" target="_blank">' +
                                    cpan_module_name(tags[j]) +
                                    '</a>'
                                );
                            }
                        }
                    }

                    $.ajax({
                        type: 'POST',
                        url: 'https://api.metacpan.org/v0/favorite/_search',
                        data: {
                            source: JSON.stringify({
                                "query": {
                                    "match_all": {}
                                },
                                "facets": {
                                    "leaderboard": {
                                        "terms": {
                                            "field": "distribution",
                                            "size": 10
                                        }
                                    }
                                },
                                "size": 0
                            })
                        }
                    }).done(on_leaderboard);

                    function on_user_recommendation (data) {
                        var count = 0;
                        var bag = {};
                        var own = [];

                        for (var i in data.rows) {
                            count++;
                            own.push(data.rows[i].key);
                            for (var similar in data.rows[i].value) {
                                if (typeof(bag[similar]) === 'undefined') {
                                    bag[similar] = 1;
                                } else {
                                    bag[similar]++;
                                }
                            }
                        }

                        for (var j in own) {
                            bag[own[j]] = 0;
                        }

                        var top_dists = [];
                        for (var word in bag) {
                            if (bag[word] > 0) {
                                top_dists.push(word);
                            }
                        }
                        top_dists = rank_sort(top_dists, bag).splice(0, 10).sort();

                        $('#for-user').html('Recommendation based on ' + count + ' favorited distributions.<br>');
                        for (var k in top_dists) {
                            //console.log("%s %s", top_dists[i], bag[top_dists[i]]);
                            $('#for-user').append(
                                ' <a class="btn btn-small btn-inverse" type="button" href="https://metacpan.org/release/' +
                                top_dists[k] +
                                '" target="_blank">' +
                                cpan_module_name(top_dists[k]) +
                                '</a>'
                            );
                        }
                    }

                    function on_user_favorites (data) {
                        var favs;
                        try {
                            favs = data.favorite.hits.hits.map(function (obj) {
                                return obj._source.distribution;
                            });
                        } catch(e) {
                            $('#for-user').html('<span class="btn btn-warning btn-block">User has no registered favorites!</span>');
                            return;
                        }

                        $.ajax({
                            type: 'GET',
                            url: 'https://creaktive.cloudant.com/metacpan-recommendation/_design/recommend/_view/recommend',
                            dataType: 'jsonp',
                            data: {
                                group: true,
                                keys: '["' + favs.join('","') + '"]',
                                stale: 'ok'
                            }
                        }).done(on_user_recommendation);
                    }

                    $('#query-recommendation').submit(function () {
                        var pause = $('#pause').val().toUpperCase();

                        $('#for-user').html('Processing...');
                        $.ajax({
                            type: 'POST',
                            url: 'https://api.metacpan.org/v0/author/' + pause,
                            data: {
                                join: 'favorite'
                            }
                        })
                            .fail(function (jqXHR, textStatus, errorThrown) {
                                $('#for-user').html('<span class="btn btn-danger btn-block">Error: ' + errorThrown + '</span>');
                            })
                            .done(on_user_favorites);
                    });
                });
            })(window.jQuery);
        </script>
    </body>
</html>
